generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            Int                @id @default(autoincrement())
  name          String
  email         String             @unique
  password      String // Hashed password (bcrypt)
  refreshToken  String? // For JWT refresh flow
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  ownedSpaces   Space[]            @relation("SpaceOwner") // Spaces created by this user
  spaceMembers  SpaceMember[] // Spaces this user belongs to
  gifts         Gift[] // Gifts given by this user
  wishlistItems WishlistItem[] // Items created by this user
  ownedRewards  Reward[] // Rewards created by this user
  ledgerEntries LedgerEntry[] // Point transactions
  activities    Activity[] // Activities performed
  redemptions   RewardRedemption[] // Rewards redeemed
}

model Space {
  id            Int                @id @default(autoincrement())
  name          String
  description   String?
  inviteCode    String             @unique
  joinCode      String             @unique
  mode          String
  points        Int                @default(0)
  ownerId       Int? // User who created the space
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  owner         User?              @relation("SpaceOwner", fields: [ownerId], references: [id])
  members       SpaceMember[] // Users who are members
  wishlistItems WishlistItem[]
  rewards       Reward[]
  ledger        LedgerEntry[]
  activities    Activity[]
  redemptions   RewardRedemption[]
}

model SpaceMember {
  id       Int      @id @default(autoincrement())
  spaceId  Int
  userId   Int
  role     Role     @default(MEMBER)
  joinedAt DateTime @default(now())
  space    Space    @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([spaceId, userId]) // A user can only be in a space once
  @@index([userId]) // Fast lookup of user's spaces
  @@index([spaceId]) // Fast lookup of space members
}

model WishlistItem {
  id         Int       @id @default(autoincrement())
  spaceId    Int
  creatorId  Int // User who created this wishlist item
  title      String
  url        String?
  image      String?
  priceCents Int?
  category   String?
  notes      String?
  priority   Priority  @default(MEDIUM)
  archived   Boolean   @default(false)
  archivedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  space      Space     @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  creator    User      @relation(fields: [creatorId], references: [id])
  gift       Gift?

  @@index([spaceId, archived]) // Fast filtering by space and archived status
  @@index([creatorId]) // Fast lookup of user's wishlist items
}

model Gift {
  id                Int          @id @default(autoincrement())
  wishlistItemId    Int          @unique
  giverId           Int?
  status            GiftStatus   @default(PENDING)
  sentimentPoints   Int?
  pricePointsLocked Int?
  reservedAt        DateTime?
  purchasedAt       DateTime?
  deliveredAt       DateTime?
  receivedAt        DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  wishlistItem      WishlistItem @relation(fields: [wishlistItemId], references: [id])
  giver             User?        @relation(fields: [giverId], references: [id])

  @@index([wishlistItemId])
}

model Reward {
  id          Int                @id @default(autoincrement())
  spaceId     Int
  ownerId     Int // User who created this reward
  title       String
  points      Int
  description String?
  icon        String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  space       Space              @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  owner       User               @relation(fields: [ownerId], references: [id])
  redemptions RewardRedemption[]

  @@index([spaceId, ownerId])
  @@index([ownerId]) // Fast lookup of user's rewards
}

model LedgerEntry {
  id        Int             @id @default(autoincrement())
  spaceId   Int
  userId    Int // User this transaction belongs to
  type      LedgerEntryType
  points    Int
  reason    String
  meta      Json?
  createdAt DateTime        @default(now())
  space     Space           @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id])

  @@index([spaceId, userId, createdAt])
  @@index([userId]) // Fast lookup of user's ledger
}

model Activity {
  id        Int          @id @default(autoincrement())
  spaceId   Int
  actorId   Int // User who performed this activity
  type      ActivityType
  payload   Json?
  createdAt DateTime     @default(now())
  space     Space        @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  actor     User         @relation(fields: [actorId], references: [id])

  @@index([spaceId, createdAt])
  @@index([actorId]) // Fast lookup of user's activities
}

model RewardRedemption {
  id         Int              @id @default(autoincrement())
  spaceId    Int
  rewardId   Int
  redeemerId Int // User who redeemed the reward
  status     RedemptionStatus @default(PENDING)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  reward     Reward           @relation(fields: [rewardId], references: [id], onDelete: Cascade)
  space      Space            @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  redeemer   User             @relation(fields: [redeemerId], references: [id])

  @@index([spaceId, redeemerId, createdAt])
  @@index([redeemerId]) // Fast lookup of user's redemptions
}

enum Role {
  OWNER
  ADMIN
  MEMBER
}

enum LedgerEntryType {
  CREDIT
  DEBIT
}

enum ActivityType {
  wishlist_add
  reward_add
  reward_edit
  reward_redeem
}

enum RedemptionStatus {
  PENDING
  REDEEMED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum GiftStatus {
  PENDING
  RESERVED
  PURCHASED
  DELIVERED
  RECEIVED
}

// Test Plan:
// Join (success)
// curl -X POST http://127.0.0.1:3000/spaces/join
// -H "Content-Type: application/json"
// -d '{"code":"ABC123"}'
// Join (not found)
// curl -X POST http://127.0.0.1:3000/spaces/join
// -H "Content-Type: application/json"
// -d '{"code":"NOPE42"}'
// Get code (owner)
// curl -H "x-owner: true" http://127.0.0.1:3000/spaces/1/code
// Rotate code (owner)
// curl -X POST -H "x-owner: true" http://127.0.0.1:3000/spaces/1/code/rotate
